- name: Execute RScanner and process results
        id: scan
        timeout-minutes: 45
        run: |
          set -euo pipefail
          echo "════════════════════════════════════════════════════════"
          echo "  Phase 1: Running RScanner Binary"
          echo "════════════════════════════════════════════════════════"
          
          BIN="${{ env.SCAN_BINARY }}"
          LOG="${{ env.SCAN_LOG }}"
          METRICS="${{ env.METRICS_FILE }}"
          TIMEOUT="${{ env.SCANNER_TIMEOUT }}"
          
          WORK_DIR=$(mktemp -d)
          trap "rm -rf '$WORK_DIR'" EXIT
          
          RAW_SCAN="$WORK_DIR/raw_scan.log"
          LIVE_IPS="$WORK_DIR/live_ips.txt"
          SCORED_RESULTS="$WORK_DIR/scored_results.json"
          
          : > "$LOG"
          : > "$RAW_SCAN"
          
          echo "=> Starting RScanner execution..."
          START_TIME=$(date +%s)
          
          set +e
          timeout "${TIMEOUT}s" "$BIN" > "$RAW_SCAN" 2>&1
          SCAN_EXIT=$?
          set -e
          
          END_TIME=$(date +%s)
          SCAN_DURATION=$((END_TIME - START_TIME))
          
          if [ "$SCAN_EXIT" -eq 0 ]; then
            echo "✅ RScanner completed successfully in ${SCAN_DURATION}s"
          elif [ "$SCAN_EXIT" -eq 124 ]; then
            echo "WARNING: Scanner timeout (${TIMEOUT}s) - using partial results"
          else
            echo "WARNING: Scanner exit code $SCAN_EXIT - continuing with available data"
          fi
          
          cp "$RAW_SCAN" "$LOG"
          
          echo ""
          echo "=> RScanner output preview (first 50 lines):"
          head -n 50 "$RAW_SCAN" || true
          echo ""
          echo "=> RScanner output preview (last 50 lines):"
          tail -n 50 "$RAW_SCAN" || true
          echo ""
          echo "=> Total lines in RScanner output: $(wc -l < "$RAW_SCAN")"
          
          echo ""
          echo "=> Checking if RScanner created any output files..."
          ls -la sub/ || true
          
          if [ -f "sub/ProxyIP-Daily.md" ]; then
            echo ""
            echo "=> Found ProxyIP-Daily.md file (first 30 lines):"
            head -n 30 sub/ProxyIP-Daily.md || true
          fi
